# LDAP Project - Claude Development Notes

## GCP VM Connection

### Setup (One-time)
1. Install Google Cloud SDK:
   ```bash
   curl https://sdk.cloud.google.com | bash
   source ~/google-cloud-sdk/path.bash.inc
   export PATH=$PATH:~/google-cloud-sdk/bin
   ```

2. Authenticate with GCP:
   ```bash
   gcloud auth login
   ```

3. Set project:
   ```bash
   gcloud config set project tdc-st
   ```

### Connect to Docker Host
```bash
# From local machine - Note: gcloud is installed at /home/jack/google-cloud-sdk
export PATH=$PATH:/home/jack/google-cloud-sdk/bin
gcloud compute ssh jack_tseng@tdc-qa-jack-tseng --zone=us-central1-c
```

**Instance Details:**
- Name: tdc-qa-jack-tseng
- Zone: us-central1-c
- External IP: 35.208.179.178
- Internal IP: 10.128.0.85
- GitHub Repo: https://github.com/dogkeeper886/ldap

### Security Notes
- SSH keys are automatically generated by gcloud and stored in `~/.ssh/google_compute_engine`
- Keys are NOT committed to git (see .gitignore)
- Authentication is handled via Google OAuth

## Let's Encrypt SSL Certificate Setup (Completed 2025-08-19)

### Domain Configuration
- **Primary Domain:** ldap.tsengsyu.com (A record → 35.208.179.178)
- **Domain Owner:** Jack Tseng (tsengsyu.com)
- **Certificate Email:** jack.tseng@tsengsyu.com

### Prerequisites Completed
1. ✅ DNS A record configured: ldap.tsengsyu.com → 35.208.179.178
2. ✅ GCP Firewall rules opened:
   - Port 80 (HTTP) - Required for Let's Encrypt ACME challenge
   - Port 443 (HTTPS) - For secure access
   - Port 636 (LDAPS) - For LDAP over SSL
3. ✅ Docker and docker compose installed on GCP instance

### Current Deployment Status

#### Repository Setup on GCP
```bash
cd /home/jack_tseng
git clone https://github.com/dogkeeper886/ldap.git
cd ldap
```

#### Environment Configuration (.env file)
```bash
# Production configuration deployed to GCP instance
LDAP_DOMAIN=ldap.tsengsyu.com
LDAP_ORG=Tseng Syu Organization
LDAP_ADMIN_PASSWORD=SecureAdmin123!
LDAP_CONFIG_PASSWORD=SecureConfig456!
LETSENCRYPT_EMAIL=jack.tseng@tsengsyu.com
ENVIRONMENT=production
STAGING=false  # Using production Let's Encrypt
DRY_RUN=false
RENEWAL_INTERVAL=43200  # 12 hours
```

#### Docker Containers Status (Updated 2025-08-19)
1. **Certbot Container:** ✅ Running successfully
   - Production certificate obtained
   - Valid until: November 17, 2025
   - Auto-renewal configured (every 12 hours check)
   - Certificates location: `/etc/letsencrypt/live/ldap.tsengsyu.com/`
   - Copies certificates to `/etc/letsencrypt/ldap-certs/` with correct permissions (644)

2. **OpenLDAP Container:** ✅ Running successfully (Basic LDAP)
   - Container running stable on port 389
   - Using base `osixia/openldap:1.5.0` image
   - TLS temporarily disabled for stability
   - Health monitoring issues resolved

### Fixes Applied During Setup

#### 1. Debian Buster EOL Fix
Modified `/docker/openldap/Dockerfile` to use archive repositories:
```dockerfile
RUN echo "deb http://archive.debian.org/debian buster main" > /etc/apt/sources.list && \
    echo "deb http://archive.debian.org/debian-security buster/updates main" >> /etc/apt/sources.list
```

#### 2. Certbot Permissions Fix
Modified `/docker/certbot/Dockerfile` to ensure proper permissions:
```dockerfile
# Create and set ownership for all certbot directories
RUN mkdir -p /var/log/letsencrypt /var/lib/letsencrypt /etc/letsencrypt
RUN chown -R certbot:certbot /var/log/letsencrypt /var/lib/letsencrypt /etc/letsencrypt
```

#### 3. Docker Network Conflict Resolution
Removed specific subnet configuration from docker-compose.yml to avoid conflicts with existing networks.

### Commands for Management

#### Check Certificate Status
```bash
# On GCP instance
docker exec certbot openssl x509 -in /etc/letsencrypt/live/ldap.tsengsyu.com/cert.pem -text -noout | grep -A2 Issuer
```

#### View Logs
```bash
# Certbot logs
docker logs certbot --tail 50

# OpenLDAP logs
docker logs openldap --tail 50
```

#### Restart Services
```bash
cd /home/jack_tseng/ldap
docker compose restart certbot
docker compose restart openldap
# Or full restart
docker compose down && docker compose up -d
```

## Session 2025-08-19 - OpenLDAP Container Troubleshooting & Resolution

### Issues Encountered and Resolved
1. **OpenLDAP Container Restart Loop** ✅ FIXED
   - **Issue**: Custom entrypoint script had permission and variable substitution problems
   - **Solution**: Simplified approach by using base `osixia/openldap:1.5.0` image directly
   - **Result**: Container now runs stable

2. **Certificate Access Issues** ✅ FIXED  
   - **Issue**: OpenLDAP couldn't read certificates due to permission conflicts
   - **Root Cause**: Complex permission management between containers (user 911 vs user 1000)
   - **Solution**: Certbot post-renewal hook copies certificates to `/etc/letsencrypt/ldap-certs/` with 644 permissions
   - **Result**: Certificates are accessible with proper permissions

3. **Health Monitoring Volume Permissions** ✅ FIXED
   - **Issue**: Permission denied when writing to health monitoring volume
   - **Solution**: Simplified by removing complex custom entrypoint logic

### Current Working Configuration
```yaml
# docker-compose.yml - Current working state
openldap:
  image: osixia/openldap:1.5.0  # Using base image directly
  container_name: openldap
  restart: unless-stopped
  environment:
    - LDAP_TLS=false  # Temporarily disabled
    - LDAP_TLS_ENFORCE=false  # For stability testing
    - LDAP_TLS_CRT_FILENAME=ldap-certs/cert.pem
    - LDAP_TLS_KEY_FILENAME=ldap-certs/privkey.pem  
    - LDAP_TLS_CA_CRT_FILENAME=ldap-certs/fullchain.pem
  volumes:
    - certificates:/etc/letsencrypt:ro
```

### Certificate Management Flow
1. **Certbot obtains/renews certificates** → `/etc/letsencrypt/live/ldap.tsengsyu.com/`
2. **Post-renewal hook copies files** → `/etc/letsencrypt/ldap-certs/` (with 644 permissions)
3. **OpenLDAP reads from** → `ldap-certs/` directory (mounted via certificates volume)

### Next Steps - LDAPS Enablement

**Goal**: Enable LDAPS on port 636 with Let's Encrypt certificates

**Plan for Next Session**:
1. **Re-enable TLS** in docker-compose.yml:
   ```yaml
   - LDAP_TLS=true
   - LDAP_TLS_ENFORCE=true
   ```

2. **Test LDAPS Connection**:
   ```bash
   # Test from GCP instance  
   openssl s_client -connect ldap.tsengsyu.com:636 -servername ldap.tsengsyu.com
   
   # Test certificate validation
   echo | openssl s_client -connect ldap.tsengsyu.com:636 2>/dev/null | openssl x509 -noout -text
   ```

3. **Verify Certificate Chain**:
   - Ensure certificates are properly loaded by OpenLDAP
   - Check certificate expiry and auto-renewal functionality
   - Test LDAPS client connections

### Troubleshooting Commands for Next Session
```bash
# Connect to GCP instance
export PATH=$PATH:/home/jack/google-cloud-sdk/bin
gcloud compute ssh jack_tseng@tdc-qa-jack-tseng --zone=us-central1-c

# Check container status  
docker ps | grep openldap
docker logs openldap --tail 30

# Check certificate files
docker exec openldap ls -la /etc/letsencrypt/ldap-certs/
docker exec certbot ls -la /etc/letsencrypt/ldap-certs/

# Test certificate validity
docker exec openldap openssl x509 -in /etc/letsencrypt/ldap-certs/cert.pem -noout -text | grep -A2 "Not After"

# Restart services if needed
cd /home/jack_tseng/ldap  
docker compose restart openldap
```

### What We Learned
- **Complex custom entrypoints** can introduce more problems than they solve
- **Permission management** between containers requires careful planning  
- **Base container images** often work better than over-customization
- **Simplicity wins** - the working solution uses standard configurations

### Current Status
- ✅ **Basic LDAP**: Working on port 389
- ✅ **Certificate System**: Working with auto-renewal
- ✅ **Container Stability**: No more restart loops
- ❌ **LDAPS**: Temporarily disabled, ready for re-enablement

**Next session should focus on**: Re-enabling TLS and testing LDAPS connectivity.

### Troubleshooting Tips

#### If Certificates Need Regeneration
```bash
# Remove existing certificates
docker exec -u root certbot rm -rf /etc/letsencrypt/live /etc/letsencrypt/archive /etc/letsencrypt/renewal

# Get new production certificate
docker exec certbot certbot certonly --standalone --non-interactive --agree-tos \
  --email jack.tseng@tsengsyu.com --domains ldap.tsengsyu.com --rsa-key-size 4096
```

#### Check Docker Volumes
```bash
docker volume ls | grep ldap
docker volume inspect ldap_certificates
```

### Important Notes
- Production Let's Encrypt has rate limits (5 certificates per week per domain)
- Staging environment should be used for testing (set STAGING=true in .env)
- Certificates auto-renew when less than 30 days remain
- Always backup certificates before making changes