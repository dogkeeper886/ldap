# Custom PostgreSQL queries for FreeRADIUS
# Extended to include NAS-Identifier in radacct and radpostauth

sql_user_name = "%{User-Name}"

event_timestamp_epoch = "%{%{integer:Event-Timestamp}:-%l}"
event_timestamp = "TO_TIMESTAMP(${event_timestamp_epoch})"

# Accounting queries
accounting {
    reference = "%{tolower:type.%{%{Acct-Status-Type}:-%{Request-Processing-Stage}}.query}"

    column_list = "\
        acctsessionid, \
        acctuniqueid, \
        username, \
        realm, \
        nasipaddress, \
        nasidentifier, \
        nasportid, \
        nasporttype, \
        acctstarttime, \
        acctupdatetime, \
        acctstoptime, \
        acctsessiontime, \
        acctauthentic, \
        connectinfo_start, \
        connectinfo_stop, \
        acctinputoctets, \
        acctoutputoctets, \
        calledstationid, \
        callingstationid, \
        acctterminatecause, \
        servicetype, \
        framedprotocol, \
        framedipaddress, \
        framedipv6address, \
        framedipv6prefix, \
        framedinterfaceid, \
        delegatedipv6prefix"

    type {
        accounting-on {
            query = "\
                UPDATE ${....acct_table1} \
                SET \
                    acctstoptime = ${....event_timestamp}, \
                    acctupdatetime = ${....event_timestamp}, \
                    acctsessiontime = (${....event_timestamp_epoch} - EXTRACT(EPOCH FROM(acctstarttime))), \
                    acctterminatecause = '%{%{Acct-Terminate-Cause}:-NAS-Reboot}' \
                WHERE acctstoptime IS NULL \
                AND nasipaddress = '%{%{NAS-IPv6-Address}:-%{NAS-IP-Address}}'::inet \
                AND acctstarttime <= ${....event_timestamp}"
        }

        accounting-off {
            query = "${..accounting-on.query}"
        }

        start {
            query = "\
                INSERT INTO ${....acct_table1} \
                    (${...column_list}) \
                VALUES(\
                    '%{Acct-Session-Id}', \
                    '%{Acct-Unique-Session-Id}', \
                    '%{SQL-User-Name}', \
                    NULLIF('%{Realm}', ''), \
                    '%{%{NAS-IPv6-Address}:-%{NAS-IP-Address}}', \
                    '%{NAS-Identifier}', \
                    NULLIF('%{%{NAS-Port-ID}:-%{NAS-Port}}', ''), \
                    '%{NAS-Port-Type}', \
                    ${....event_timestamp}, \
                    ${....event_timestamp}, \
                    NULL, \
                    0, \
                    '%{Acct-Authentic}', \
                    '%{Connect-Info}', \
                    NULL, \
                    0, \
                    0, \
                    '%{Called-Station-Id}', \
                    '%{Calling-Station-Id}', \
                    NULL, \
                    '%{Service-Type}', \
                    '%{Framed-Protocol}', \
                    NULLIF('%{Framed-IP-Address}', '')::inet, \
                    NULLIF('%{Framed-IPv6-Address}', '')::inet, \
                    NULLIF('%{Framed-IPv6-Prefix}', '')::inet, \
                    NULLIF('%{Framed-Interface-Id}', ''), \
                    NULLIF('%{Delegated-IPv6-Prefix}', '')::inet) \
                ON CONFLICT (acctuniqueid) \
                DO UPDATE \
                SET \
                    acctstarttime = ${....event_timestamp}, \
                    acctupdatetime = ${....event_timestamp}, \
                    connectinfo_start = '%{Connect-Info}'"
        }

        interim-update {
            query = "\
                UPDATE ${....acct_table1} \
                SET \
                    framedipaddress = NULLIF('%{Framed-IP-Address}', '')::inet, \
                    framedipv6address = NULLIF('%{Framed-IPv6-Address}', '')::inet, \
                    framedipv6prefix = NULLIF('%{Framed-IPv6-Prefix}', '')::inet, \
                    framedinterfaceid = NULLIF('%{Framed-Interface-Id}', ''), \
                    delegatedipv6prefix = NULLIF('%{Delegated-IPv6-Prefix}', '')::inet, \
                    acctsessiontime = %{%{Acct-Session-Time}:-NULL}, \
                    acctinterval = (${....event_timestamp_epoch} - EXTRACT(EPOCH FROM (COALESCE(acctupdatetime, acctstarttime)))), \
                    acctupdatetime = ${....event_timestamp}, \
                    acctinputoctets = (('%{%{Acct-Input-Gigawords}:-0}'::bigint << 32) + \
                        '%{%{Acct-Input-Octets}:-0}'::bigint), \
                    acctoutputoctets = (('%{%{Acct-Output-Gigawords}:-0}'::bigint << 32) + \
                        '%{%{Acct-Output-Octets}:-0}'::bigint) \
                WHERE acctuniqueid = '%{Acct-Unique-Session-Id}' \
                AND acctstoptime IS NULL"
        }

        stop {
            query = "\
                UPDATE ${....acct_table1} \
                SET \
                    acctstoptime = ${....event_timestamp}, \
                    acctupdatetime = ${....event_timestamp}, \
                    acctsessiontime = %{%{Acct-Session-Time}:-NULL}, \
                    acctinputoctets = (('%{%{Acct-Input-Gigawords}:-0}'::bigint << 32) + \
                        '%{%{Acct-Input-Octets}:-0}'::bigint), \
                    acctoutputoctets = (('%{%{Acct-Output-Gigawords}:-0}'::bigint << 32) + \
                        '%{%{Acct-Output-Octets}:-0}'::bigint), \
                    acctterminatecause = '%{Acct-Terminate-Cause}', \
                    connectinfo_stop = '%{Connect-Info}', \
                    framedipaddress = NULLIF('%{Framed-IP-Address}', '')::inet, \
                    framedipv6address = NULLIF('%{Framed-IPv6-Address}', '')::inet, \
                    framedipv6prefix = NULLIF('%{Framed-IPv6-Prefix}', '')::inet, \
                    framedinterfaceid = NULLIF('%{Framed-Interface-Id}', ''), \
                    delegatedipv6prefix = NULLIF('%{Delegated-IPv6-Prefix}', '')::inet \
                WHERE acctuniqueid = '%{Acct-Unique-Session-Id}'"
        }
    }
}

# Post-auth query with NAS info
post-auth {
    query = "\
        INSERT INTO ${..postauth_table} \
            (username, pass, reply, nasipaddress, nasidentifier, calledstationid, callingstationid, authdate) \
        VALUES(\
            '%{User-Name}', \
            '%{%{User-Password}:-%{Chap-Password}}', \
            '%{reply:Packet-Type}', \
            '%{%{NAS-IPv6-Address}:-%{NAS-IP-Address}}', \
            '%{NAS-Identifier}', \
            '%{Called-Station-Id}', \
            '%{Calling-Station-Id}', \
            NOW())"
}

# Authorization queries
authorize_check_query = "\
    SELECT id, username, attribute, value, op \
    FROM ${authcheck_table} \
    WHERE username = '%{SQL-User-Name}' \
    ORDER BY id"

authorize_reply_query = "\
    SELECT id, username, attribute, value, op \
    FROM ${authreply_table} \
    WHERE username = '%{SQL-User-Name}' \
    ORDER BY id"

authorize_group_check_query = "\
    SELECT id, groupname, attribute, value, op \
    FROM ${groupcheck_table} \
    WHERE groupname IN (\
        SELECT groupname FROM ${usergroup_table} \
        WHERE username = '%{SQL-User-Name}' \
        ORDER BY priority) \
    ORDER BY id"

authorize_group_reply_query = "\
    SELECT id, groupname, attribute, value, op \
    FROM ${groupreply_table} \
    WHERE groupname IN (\
        SELECT groupname FROM ${usergroup_table} \
        WHERE username = '%{SQL-User-Name}' \
        ORDER BY priority) \
    ORDER BY id"

group_membership_query = "\
    SELECT groupname \
    FROM ${usergroup_table} \
    WHERE username = '%{SQL-User-Name}' \
    ORDER BY priority"
