services:
    postgres:
        image: postgres:15-alpine
        container_name: radius-postgres
        restart: unless-stopped
        environment:
            - POSTGRES_DB=radius
            - POSTGRES_USER=radius
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-radiuspass123}
            - TEST_USER_PASSWORD=${TEST_USER_PASSWORD:-testpass123}
            - GUEST_USER_PASSWORD=${GUEST_USER_PASSWORD:-guestpass123}
        volumes:
            - postgres-data:/var/lib/postgresql/data
            - ./sql/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
            - ./sql/seed.sql.template:/docker-entrypoint-initdb.d/seed.sql.template:ro
            - ./sql/init-seed.sh:/docker-entrypoint-initdb.d/02-seed.sh:ro
        networks:
            - radius-network
        logging:
            driver: json-file
            options:
                max-size: "10m"
                max-file: "3"

    freeradius:
        build:
            context: ./docker/freeradius
            dockerfile: Dockerfile
        image: freeradius-server-tls:latest
        container_name: freeradius-server
        hostname: ${RADIUS_DOMAIN:-radius.example.com}
        restart: unless-stopped
        depends_on:
            - postgres
        ports:
            # RADIUS Authentication (UDP)
            - "1812:1812/udp"
            # RADIUS Accounting (UDP)
            - "1813:1813/udp"
            # RADIUS over TLS (TCP)
            - "2083:2083/tcp"
        environment:
            - RADIUS_DOMAIN=${RADIUS_DOMAIN:-radius.example.com}
            - RADIUS_SECRET=${RADIUS_SECRET:-changeme123}
            - ENVIRONMENT=${ENVIRONMENT:-development}
            - FREERADIUS_LOG_LEVEL=${FREERADIUS_LOG_LEVEL:-info}
            - ENABLE_TLS=${ENABLE_TLS:-true}
            - DEBUG_MODE=${DEBUG_MODE:-false}
            - TLS_CERT_FILE=cert.pem
            - TLS_KEY_FILE=privkey.pem
            - TLS_CA_FILE=fullchain.pem
            # Database configuration
            - POSTGRES_HOST=radius-postgres
            - POSTGRES_PORT=5432
            - POSTGRES_DB=radius
            - POSTGRES_USER=radius
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-radiuspass123}
            # Test user credentials
            - TEST_USER_PASSWORD=${TEST_USER_PASSWORD:-testpass123}
            - GUEST_USER_PASSWORD=${GUEST_USER_PASSWORD:-guestpass123}
            - ADMIN_USER_PASSWORD=${ADMIN_USER_PASSWORD:-adminpass123}
            - CONTRACTOR_PASSWORD=${CONTRACTOR_PASSWORD:-contractorpass123}
            - VIP_PASSWORD=${VIP_PASSWORD:-vippass123}
        volumes:
            - radius-data:/var/log/freeradius
        networks:
            - radius-network
        logging:
            driver: json-file
            options:
                max-size: "10m"
                max-file: "3"

    mcp-radius-sql:
        build:
            context: ../mcp-radius-sql
            dockerfile: Dockerfile
        image: mcp-radius-sql:latest
        container_name: mcp-radius-sql
        restart: unless-stopped
        depends_on:
            - postgres
        ports:
            - "3443:3000"
        environment:
            - HTTP_PORT=3000
            - MCP_TOKEN=${MCP_TOKEN:-change-me-to-a-secure-token-at-least-32-chars}
            - HTTPS_ENABLED=${HTTPS_ENABLED:-true}
            - TLS_CERT_FILE=/app/certs/fullchain.pem
            - TLS_KEY_FILE=/app/certs/privkey.pem
            - POSTGRES_HOST=radius-postgres
            - POSTGRES_PORT=5432
            - POSTGRES_DB=radius
            - POSTGRES_USER=radius
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-radiuspass123}
            - LOG_LEVEL=${LOG_LEVEL:-info}
        networks:
            - radius-network
        healthcheck:
            test: ["CMD", "wget", "-q", "--spider", "--no-check-certificate", "https://localhost:3000/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 10s
        logging:
            driver: json-file
            options:
                max-size: "10m"
                max-file: "3"

volumes:
    radius-data:
        driver: local
    postgres-data:
        driver: local

networks:
    radius-network:
        driver: bridge
